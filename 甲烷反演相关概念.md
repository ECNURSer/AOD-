## 甲烷反演相关概念

**甲烷柱浓度**和**干空气混合比**是大气甲烷的两种不同物理量，主要反映甲烷在大气中的不同特性，具有不同的应用和意义。

1. **甲烷柱浓度**：
   - **定义**：通常是指单位面积上的大气柱内所有甲烷的总含量，单位为mol/m²或ppb (parts per billion, 十亿分之一)。反映的是垂直方向上整个大气柱中的甲烷含量。
   - **应用**：主要用于大气中甲烷的空间分布监测以及排放源识别。例如在气候模型中，甲烷柱浓度可以帮助理解不同区域甲烷排放的贡献，并在全球气候变化研究中起到重要作用。

2. **干空气混合比**：
   - **定义**：干空气混合比指的是甲烷在单位体积干空气中的比例，通常以ppm（parts per million，百万分之一）表示。它是去除了水汽等成分后的甲烷浓度。
   - **应用**：更常用于描述大气中甲烷的体积比例，尤其在湿度变化明显的情况下使用这一量来标准化不同条件下的甲烷含量。干空气混合比可以用于更精确的空气质量研究，避免了由于水汽等因素的影响。
   - **重要性**：干空气混合比的概念有助于在不同湿度条件下保持测量的一致性，因为水汽会影响总气体体积，从而影响直接浓度的测量值。使用干空气混合比可以减少这种干扰，使结果更具有可比性。

3. **XCH4**：
   - **定义**：XCH4是指柱平均甲烷干空气混合比（column-averaged dry air mole fraction of methane），即垂直整层大气中甲烷的干空气混合比。它结合了甲烷柱浓度和干空气混合比，表示的是整个大气柱中的甲烷相对于干空气的平均浓度。
   - **应用**：XCH4广泛用于卫星遥感数据中，它消除了水汽变化的影响，是大气甲烷监测的重要指标。
   - 下面我将通过一个简单的示例数据演示如何使用匹配滤波算法反演甲烷浓度，详细走完整个流程。假设我们有一个简单的高光谱数据，其中包含甲烷吸收波段的观测数据。
   

## 匹配滤波(Matched Filter,MF)算法流程

#### 1. **观测光谱数据**（实际观测到的辐射强度）：
假设我们有以下波段的观测数据（单位：观测的辐射强度）。这些数据模拟了卫星对目标区域的高光谱观测。

| 波长 (μm) | 辐射强度 |
| --------- | -------- |
| 1.64      | 300      |
| 1.65      | 285      |
| 1.66      | 275      |
| 2.30      | 290      |
| 2.31      | 278      |
| 2.32      | 270      |

#### 2. **甲烷的光谱吸收特征**（目标光谱模板）：
从实验室或模型（如MODTRAN）中得到的甲烷吸收光谱，单位为吸收系数。

| 波长 (μm) | 吸收系数 |
| --------- | -------- |
| 1.64      | 0.2      |
| 1.65      | 0.5      |
| 1.66      | 0.8      |
| 2.30      | 0.6      |
| 2.31      | 0.7      |
| 2.32      | 0.9      |

#### 3. **背景光谱**（大气中其他气体的吸收特性）：
这是大气背景的协方差矩阵，用于描述大气背景的噪声分布。假设我们有一个简化的协方差矩阵：
$$
S = 
\begin{pmatrix}
1.0 & 0.2 & 0.1 & 0.1 & 0.05 & 0.02 \\
0.2 & 1.1 & 0.3 & 0.15 & 0.1 & 0.05 \\
0.1 & 0.3 & 1.2 & 0.2 & 0.15 & 0.1 \\
0.1 & 0.15 & 0.2 & 1.3 & 0.2 & 0.15 \\
0.05 & 0.1 & 0.15 & 0.2 & 1.4 & 0.2 \\
0.02 & 0.05 & 0.1 & 0.15 & 0.2 & 1.5
\end{pmatrix}
$$
这个矩阵描述了不同波段之间的背景噪声相互关系。

### 二、匹配滤波步骤

#### 1. **构建匹配滤波器**：
首先，我们需要基于目标光谱模板和背景协方差矩阵 $ S $ 计算匹配滤波器权重 $ w $。滤波器的权重由下式决定：
$$
w = S^{-1} \cdot t
$$
其中，$t $ 是甲烷的光谱模板向量：
$$
t = \begin{pmatrix} 0.2 \\ 0.5 \\ 0.8 \\ 0.6 \\ 0.7 \\ 0.9 \end{pmatrix}
$$
接下来，我们求解 $ w $，需要先求 $ S^{-1} $，即背景协方差矩阵的逆矩阵。我们通过数值计算工具求解矩阵逆。

#### 2. **应用匹配滤波器**：
将匹配滤波器的权重 $ w $ 应用于观测光谱数据 $ x $，我们使用以下公式：
$$

y = w^T \cdot x
$$
这里，$ x $ 是观测光谱向量：
$$

x = \begin{pmatrix} 300 \\ 285 \\ 275 \\ 290 \\ 278 \\ 270 \end{pmatrix}
$$
通过矩阵乘法，我们可以得到输出信号 $ y $，这表示每个像素的甲烷响应。

#### 3. **浓度反演**：
将滤波输出 $ y $ 转换为甲烷浓度。这个过程通常需要通过实验校准，将输出信号与实测浓度数据进行匹配。假设我们有一个简单的线性关系：
$$

\text{CH}_4\ \text{浓度 (ppb)} = \alpha \cdot y
$$
其中，$ \alpha $ 是通过实验校准得到的比例常数，假设 $ \alpha = 1.2 $。

最终，我们可以得到每个像素的甲烷浓度值。

### 三、完整流程示例

1. **输入观测光谱数据**：
   - $ x = [300, 285, 275, 290, 278, 270] $
2. **目标光谱模板**：
   - $ t = [0.2, 0.5, 0.8, 0.6, 0.7, 0.9] $
3. **背景协方差矩阵 $ S $**：
   - 上述矩阵用于计算 $ S^{-1} $。
4. **计算匹配滤波器权重 $ w $**：
   - 通过 $ S^{-1} \cdot t $ 得到权重向量 $ w $。
5. **应用匹配滤波器**：
   - 通过 $ y = w^T \cdot x $ 计算滤波后的信号 $ y $。
6. **反演甲烷浓度**：
   - 使用比例常数 $ \alpha = 1.2 $，计算甲烷浓度 $ \text{CH}_4 $ = $ 1.2 \times y $。

## 问题辨析 

### 甲烷的光谱系数特征给的是吸收系数吗？

是的，**甲烷的光谱特征通常是以吸收系数（Absorption Coefficient）**来表示的。吸收系数描述了甲烷在某个波长下对入射辐射的吸收能力，单位为 $ \text{cm}^{-1} $。吸收系数越大，说明甲烷在该波长的吸收越强。这个吸收系数用于辐射传输模型中，描述甲烷如何影响电磁辐射在大气中的传输。

公式上，辐射强度随着吸收系数的增加而呈指数衰减，表达式为：
$$
I(\lambda) = I_0(\lambda) \cdot e^{-\tau(\lambda)}
$$
其中，光学厚度 $ \tau(\lambda) $ 包含吸收系数和气体的浓度。

### 背景光谱得到的详细过程是什么？ 

**背景光谱**（或者说背景协方差矩阵 $ S $）描述了大气中其他成分（如水汽、一氧化碳等）的吸收、散射特性以及环境噪声。得到背景光谱的详细过程如下：

1. **观测数据的采集**：通过卫星观测大量背景区域的高光谱数据。这些区域应尽可能不包含目标气体（如甲烷），或者目标气体的含量非常低。

2. **背景光谱特征分析**：分析这些背景数据，提取各个波段的辐射特征，生成反映大气中其他气体和地表特征的光谱信号。

3. **噪声模型构建**：利用这些观测数据计算背景光谱的**协方差矩阵 $ S $**，它描述了不同波段之间的噪声相关性和波动性。

   协方差矩阵计算：
   $$
   
   S = \frac{1}{N-1} \sum_{i=1}^{N} (x_i - \mu)(x_i - \mu)^T
   $$
   其中：

   - $ x_i $ 是第 $ i $ 个观测光谱向量。
   - $ \mu $ 是这些观测数据的均值向量。
   - $ N $ 是观测数据的数量。

4. **背景协方差矩阵 $ S $**：这个矩阵包含了各波段的背景噪声强度以及波段之间的相关性。通过计算协方差矩阵，可以反映不同波段噪声的统计特性。

**总结**：背景光谱通过大量不含甲烷的观测数据构建协方差矩阵，用以描述背景气体和噪声的光谱行为。

### 为什么滤波权重的公式是$w = S^{-1} \cdot t $

滤波权重的公式源自**匹配滤波的基本原理**，其目标是**最大化目标信号**（甲烷的吸收光谱）与实际观测光谱的相似度，同时最小化背景噪声的干扰。该公式来源于**信号与噪声比的优化**问题。

**公式推导的核心**：

- $ t $ 是目标信号的光谱模板（甲烷的吸收系数）。
- $ S $ 是背景噪声的协方差矩阵，表示背景光谱的统计特性。

目标是选择一个权重 $ w $，使得通过观测光谱与目标信号模板的内积最大化，同时最小化噪声的影响。这个问题的解法源于最优滤波理论，解得匹配滤波器的权重为：
$$

w = S^{-1} \cdot t
$$
这表明权重向量 $ w $ 是目标光谱在噪声协方差矩阵反转后的投影。

#### **直观理解**：

- **$ S^{-1} $** 用于消除背景噪声的影响，即减少观测中由于噪声带来的不确定性。
- **$ t $** 是目标信号模板，匹配目标的吸收特征。

#### **数学理解**：

匹配滤波器权重的计算公式可以通过最大化信噪比（Signal-to-Noise Ratio, SNR）来推导。在信号处理和检测理论中，匹配滤波器设计的目标是通过线性滤波器最大化输出信号的信噪比，从而在噪声背景中有效地检测目标信号。

假设我们有一个观测信号 $ x $，它由目标信号 $ t $ 和噪声 $ n $ 组成：
$$
x = t + n
$$
我们希望设计一个滤波器 $ w $，使得滤波器输出 $ y $ 中目标信号的功率与噪声的功率之比（即信噪比）最大。

### 目标

最大化滤波器输出的信噪比：
$$
\text{SNR} = \frac{(w^T t)^2}{w^T S w}
$$
其中，$ S $ 是噪声 $ n $ 的协方差矩阵。

### 推导过程

1. **滤波器输出信号**：
   $$
   y = w^T x = w^T (t + n) = w^T t + w^T n
   $$

2. **信号部分**：
   $$
   \text{信号部分} = w^T t
   $$

3. **噪声部分**：
   $$
   \text{噪声部分} = w^T n
   $$

4. **噪声功率**：
   噪声 $ n $ 的协方差矩阵为 $ S $，因此噪声部分的功率为：
   $$
   \text{噪声功率} = \mathbb{E}[(w^T n)^2] = w^T S w
   $$

5. **信噪比（SNR）**：
   $$
   \text{SNR} = \frac{(w^T t)^2}{w^T S w}
   $$

6. **最大化信噪比**：
   为了最大化信噪比，我们需要最大化以下目标函数：
   $$
   J(w) = \frac{(w^T t)^2}{w^T S w}
   $$

   这可以通过拉格朗日乘数法来实现，其中引入约束条件 $ w^T S w = 1 $。

7. **拉格朗日函数**：
   引入拉格朗日乘数 $ \lambda $，构造拉格朗日函数：
   $$
   \mathcal{L}(w, \lambda) = (w^T t)^2 - \lambda (w^T S w - 1)
   $$

8. **求导并设为零**：
   对 $ w $ 求导并设为零：
   $$
   \frac{\partial \mathcal{L}}{\partial w} = 2 t (t^T w) - 2 \lambda S w = 0
   $$

   化简得到：
   $$
   t (t^T w) = \lambda S w
   $$

9. **解方程**：
   由于 $ t^T w $ 是一个标量，我们可以将其记为一个常数 $ \alpha $：
   $$
   t = \lambda S w
   $$
   因此，滤波器权重 $ w $ 可以表示为：
   $$
   w = \lambda S^{-1} t
   $$
   
   为了满足约束条件 $ w^T S w = 1 $，我们可以选择适当的 $ \lambda $，但通常我们只需要比例关系，因此最终得到：
   $$
   w = S^{-1} t
   $$



### 匹配滤波算法没有迭代过程吗？ 

**匹配滤波算法没有迭代过程**。匹配滤波是基于线性系统的信号处理方法，它的目标是找到一种最优的线性滤波器，通过与输入信号（观测光谱）的内积，直接得到目标信号的响应。

具体来说，**滤波过程是一次性的**，即根据给定的背景协方差矩阵 $ S $ 和目标光谱模板 $ t $，计算出权重 $ w $，然后将其应用到观测光谱 $ x $ 上，得到输出结果 $ y $。这一过程不需要迭代优化。

相比之下，某些非线性方法（如最优估计法）通常会涉及迭代过程，反复更新模型参数直至收敛。

### 浓度转换的公式要怎么得到？

**浓度转换公式**用于将匹配滤波输出的响应值 $ y $ 转换为实际的甲烷浓度。浓度转换公式通常依赖于实验或模拟校准过程，可以通过以下步骤得到：

1. **实验校准**：

   - 使用已知浓度的甲烷气体，模拟或实测其在高光谱数据中的响应值 $ y $。

   - 记录不同浓度下的响应值，建立响应值与甲烷实际浓度的映射关系。

   - 假设响应值 $ y $ 与甲烷浓度 $ C_{\text{CH}_4} $ 之间为线性关系：
     $$
     
     C_{\text{CH}_4} = \alpha \cdot y
     $$
     其中 $ \alpha $ 是一个校准常数，通过实验或模拟数据确定。

2. **模拟数据校准**：

   - 使用辐射传输模型（如MODTRAN）模拟不同甲烷浓度下的光谱吸收特性和匹配滤波输出值。通过这种方式，可以建立响应值 $ y $ 与实际浓度 $ C_{\text{CH}_4} $ 的映射。
   - 对不同的模拟场景进行拟合，得到浓度转换公式。

3. **非线性关系**：

   - 在某些情况下，响应值 $ y $ 和甲烷浓度之间可能存在非线性关系，公式可能是：
     $$
     
     C_{\text{CH}_4} = \alpha \cdot y + \beta \cdot y^2
     $$
     这里 $ \alpha $ 和 $ \beta $ 通过校准得到。

     

