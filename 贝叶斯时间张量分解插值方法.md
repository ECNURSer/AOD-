基于贝叶斯时间张量分解的插值方法（HTR-BTTF），用于处理**大面积缺失观测**的时间序列遥感数据

### 算法实现的核心步骤：

1. **张量数据的定义和分解**：时间序列遥感数据被定义为三维张量 $D \in R^{t \times m \times n}$，其中 $m$和 $n$ 表示空间维度的长度，$t$表示时间长度。通过低秩张量分解，将其分解为时间因子矩阵和空间因子矩阵，借助贝叶斯因子分解模型完成数据插值。
2. **贝叶斯模型的引入**：该方法通过贝叶斯框架对模型中的参数设置先验分布，利用马尔科夫链蒙特卡洛（MCMC）方法进行参数采样，推断缺失数据的后验分布。
3. **希尔伯特曲线进行空间重排**：遥感数据中由于云层遮盖通常会导致大面积连续的缺失。为了打散这些缺失区域，该方法利用希尔伯特填充曲线对空间维度进行重排，将大面积缺失的观测值分散到较小区域中，有助于提高插值的准确性。
4. **时间维度的重排**：为了更好地捕捉数据的周期性特征，时间维度会进行重排，使得每年的数据按周期排列，有利于提取时间序列中的规律性。
5. **贝叶斯时间张量分解插值**：经过空间和时间维度的重排后，输入到贝叶斯时间张量分解模型中进行插值。在插值过程中，时间因子矩阵和空间因子矩阵被交替更新，最终推断出缺失数据。
6. **早停机制与张量恢复**：引入早停机制，当损失函数的下降幅度小于设定的阈值时，停止训练，从而提高计算效率。最终对张量进行恢复，得到插值后的完整数据。

### 通俗解释：

可以将这一过程想象为将一个缺失数据的三维立体拼图打散，然后通过先验知识（贝叶斯方法）推测缺失部分的内容。算法通过贝叶斯推断找到最有可能的“拼图块”来填补空缺。同时，利用希尔伯特曲线将缺失数据打散，避免大块空白难以填补的问题。通过重排时间序列，算法还能充分利用数据的周期性特征，使插值更加精准。最终，经过多次迭代，算法找出最优的插值方案。

### 公式说明：

1. **贝叶斯时间张量分解模型**： 对于观察到的张量数据 $D$，我们假设每个缺失值服从独立的高斯分布：
   $$
   d_{i,j,t} \sim N \left( \sum_{r=1}^{R} u_{ir}v_{jr}x_{tr}, \tau^{-1} \right)
   $$
   其中 $u_{ir}, v_{jr}, x_{tr} $分别为空间和时间因子矩阵的元素，$\tau$ 表示观测噪声的精度。

2. **希尔伯特曲线重排**： 利用希尔伯特空间填充曲线将二维空间中的缺失区域映射为一维，使原本集中缺失的区域分散，从而减少插值中的空间不均匀性。

### 示例说明：

假设我们有一组卫星遥感数据，其中由于云层遮盖，连续的多个图像块缺失。传统方法可能无法有效处理这些大块缺失，但通过HTR-BTTF算法，我们首先利用希尔伯特曲线将这些大块空白区域打散，接着通过贝叶斯推断填补这些缺失的值。经过多轮迭代和参数优化，最终得到较为精准的插值结果。



将时序遥感数据通过低秩张量分解并利用贝叶斯因子分解模型完成插值的步骤，主要分为以下几步：

### 1. **时序遥感数据张量表示**：

首先，时序遥感数据可以表示为三维张量 $D \in \mathbb{R}^{t \times m \times n}$，其中：

- $t$ 表示时间长度（如每年有多少天的观测数据），
- $m$ 和 $n$ 分别表示空间维度的长度（即地理区域的横纵像素点数）。

张量 $D$ 包含时空数据，例如在每个时间点的地表温度值。由于各种原因（如云层遮盖），张量中的部分数据是缺失的，目标是通过插值来填补这些缺失值。

### 2. **低秩张量分解**：

低秩张量分解的目标是将三维的张量 $D$ 分解为多个因子矩阵的乘积。最常见的分解方法是 CANDECOMP/PARAFAC (CP) 分解，将原始张量表示为多个低秩矩阵的乘积：

$D \approx \sum_{r=1}^{R} u_r \circ v_r \circ x_r$

其中：

- $u_r \in \mathbb{R}^m$ 和 $v_r \in \mathbb{R}^n$ 是表示空间特征的因子矩阵，
- $x_r \in \mathbb{R}^t$ 是表示时间特征的因子矩阵，
- $R$ 是秩（通常设定较小的值来捕捉主要的时空模式），
- $\circ$ 是外积运算符。

直观上，这个分解可以理解为将复杂的三维数据拆分为空间和时间上的几个主要模式，这些模式的线性组合能够近似原始张量数据。

### 3. **贝叶斯因子分解模型**：

为了完成插值并估计缺失值，贝叶斯框架提供了一个基于概率的推断方法。我们假设张量 $D$ 的每个观察值 $d_{i,j,t}$ 服从一个高斯分布，其均值由低秩分解的因子矩阵的线性组合给出：

$d_{i,j,t} \sim N\left(\sum_{r=1}^{R} u_{ir} v_{jr} x_{tr}, \tau^{-1}\right)$

其中 $\tau$ 是观测噪声的精度，$u_{ir}, v_{jr}, x_{tr}$ 分别是因子矩阵的元素。

在贝叶斯框架下，所有的因子矩阵（$U$、$V$、$V$）以及噪声参数 $\tau$ 都被赋予先验分布。典型的先验分布设置如下：

- 因子矩阵 $U$ 和 $V$ 的每一行服从多元高斯分布：$u_i \sim N(\mu_u, \Lambda_u^{-1}), \quad v_j \sim N(\mu_v, \Lambda_v^{-1})$
- 噪声精度$\tau$ 服从 Gamma 分布： $\tau \sim \text{Gamma}(\alpha, \beta)$

通过这种方式，我们将插值问题转换为一个贝叶斯推断问题。

### 4. **MCMC 采样与参数估计**：

由于直接求解所有参数的后验分布是非常困难的，因此我们使用马尔科夫链蒙特卡洛（MCMC）方法，通常是 Gibbs 采样。Gibbs 采样的基本思想是：

- 依次更新每一个因子矩阵 $U$、$V$、$X$，在更新时固定其他因子矩阵不变，条件分布是基于当前观测数据和其他矩阵的推断。
- 对于缺失值，我们根据已更新的参数从后验分布中采样来填补。

通过多轮采样迭代，最终的参数估计会逐步收敛到缺失数据的最佳估计。

### 5. **插值结果**：

经过若干次迭代后，贝叶斯模型会生成所有因子矩阵的后验分布，从而我们可以得到完整的低秩张量分解模型。在这个模型中，缺失的数据点通过估计的因子矩阵得以重建，最终填补了遥感数据中的大面积缺失值。



# 空间因子矩阵和时间因子矩阵的确定过程

 **空间因子矩阵** $U$ 和 $V$以及 **时间因子矩阵** $X$ 在 BTTF（贝叶斯时间张量分解）算法中的确定过程。我们将通过具体步骤解释这些因子矩阵是如何通过贝叶斯推断逐步优化确定的。

## 1. 空间因子矩阵 \(U\) 和 \(V\) 的确定

空间因子矩阵 $U$ 和 $V$ 捕捉了遥感数据在空间维度上的特征。为了确定这些因子矩阵的值，贝叶斯推断通过 **Gibbs 采样** 更新这些矩阵。

### 1.1 CP 分解模型

假设时序遥感数据表示为张量 \( D \in \mathbb{R}^{t \times m \times n} \)，我们使用 **CANDECOMP/PARAFAC (CP) 分解** 将这个张量表示为：
$$
D \approx \sum_{r=1}^{R} u_r \circ v_r \circ x_r
$$
其中，\(U\) 和 \(V\) 分别是表示空间维度的因子矩阵，\( X \) 是时间维度的因子矩阵。

### 1.2 贝叶斯推断和条件分布

在贝叶斯框架下，我们希望推断出 \(U\) 和 \(V\) 的后验分布。通过贝叶斯定理，\(U\) 的后验分布可以表示为：
$$
p(U \mid D, V, X) \propto p(D \mid U, V, X) \cdot p(U)
$$

- $p(D \mid U, V, X)$：**似然函数**，表示观测数据 \(D\) 给定因子矩阵$U$ 、 $V$ 、$X$ 后的分布。
- $p(U)$：**先验分布**，假设 \(U\) 服从正态分布 $N(0, \lambda_U^2)$。

#### 更新 \(U\) 和 \(V\)

通过 Gibbs 采样更新$U$ 和 $V$ 的每一行。假设我们固定$V$和 $X$，然后采样$U$的每一行。更新 $V$ 的过程类似，固定 $U$ 和 $V$ ，然后采样 $V$的每一行。

每次采样后，我们根据当前矩阵的值计算似然函数，并结合先验分布，更新每个因子矩阵的值。

## 2. 时间因子矩阵 \(X\) 的确定

时间因子矩阵 \(X\) 捕捉了时间维度上的变化特征。由于时间序列数据通常具有时间相关性，BTTF 使用 **向量自回归模型（VAR）** 来确定时间因子矩阵 \(X\) 的值。

### 2.1 向量自回归模型 (VAR)

向量自回归模型假设当前时间点的因子 \( x_t \) 依赖于前 \(c\) 个时间点的因子：
$$
x_t = \sum_{k=1}^{c} A_k x_{t-k} + \epsilon_t
$$
其中：
- $A_k$ 是自回归系数矩阵，表示不同时间点之间的依赖关系。
- $\epsilon_t$ 是噪声项，表示不可预测的误差。

### 2.2 贝叶斯推断和条件分布

为了更新时间因子矩阵 \(X\)，我们通过贝叶斯推断推导出时间因子矩阵的条件后验分布。假设时间因子矩阵的先验为：
$$
p(X) \sim N(0, \lambda_X^2)
$$
根据贝叶斯定理，\(X\) 的后验分布为：
$$
p(X \mid D, U, V) \propto p(D \mid U, V, X) \cdot p(X)
$$


- $p(D \mid U, V, X)$：**似然函数**，表示观测数据$D$ 给定 $U$ 、 $V$ 、$X$后的分布。
- $p(X)$：**先验分布**，假设时间因子矩阵$X$ 服从正态分布。

通过固定 $U$ 和 $V$，然后从时间因子矩阵 $X$ 的条件后验分布中抽样更新其值。

---



# Gibbs 采样中的条件分布计算示例

本文档详细解释了如何通过 **Gibbs 采样** 计算参数的条件后验分布，并逐步推导后验分布的 **均值** 和 **方差**。我们将通过一个具体的例子，展示如何从似然函数和先验分布中推导出后验分布。

## 问题背景：

我们假设有如下矩阵分解模型：

$D \approx U \cdot V^T$

其中 $D$ 是观测矩阵，$U$ 和 $V$ 是我们要优化的因子矩阵。目标是通过 Gibbs 采样更新 $U$ 和 $V$ 的值，并填补缺失值。

### 已知：

1. 观测矩阵$D$的部分值：例如 $D_{11} = 5$。

2. 初始因子矩阵：

   $U = \begin{pmatrix} u_1 \\ u_2 \end{pmatrix}, \quad V = \begin{pmatrix} v_1 \\ v_2 \end{pmatrix}$

3. 观测噪声 $\sigma^2 = 1$（假设噪声方差为 1）。

4. 先验假设：$U_1 \sim N(0, 1)$ 和 $V_1 \sim N(0, 1)$，即我们对 $U_1$ 和$V_1$的先验分布是标准正态分布。

### 目标：

利用贝叶斯推断，计算 $U_1$ 的后验分布 $p(U_1 \mid D, V_1)$，并从中抽取一个新的 $U_1$ 值。

------

## 1. 贝叶斯定理与条件后验分布

根据贝叶斯定理，$U_1$ 的后验分布是：

- $p(U_1 \mid D, V_1) \propto p(D_{11} \mid U_1, V_1) \cdot p(U_1)$

- $p(D_{11} \mid U_1, V_1)$：**似然函数**，表示给定 $U_1$和 $V_1$ 后，观测数据 $D_{11}$ 的分布。
- $p(U_1)$：**先验分布**，表示我们对 $U_1$ 的初始假设。

------

## 2. 似然函数的推导

观测值 $D_{11}$ 服从正态分布 $N(U_1 \cdot V_1, \sigma^2)$，即：

$p(D_{11} \mid U_1, V_1) \sim N(U_1 \cdot V_1, \sigma^2)$

$p(D∣U,V)=∏_{(i,j)∈observed}N(Dij∣Ui⋅VjT,σ2)$

这是因为根据矩阵分解的假设，矩阵 $D$ 中的元素是通过 $U$ 和 $V$ 的内积生成的，并且加入了噪声 $\sigma^2$。

观测值$D_{ij}$服从正态分布$N(U_i \cdot V_j^T, \sigma^2)$，即每个观测值的均值是$U_i \cdot V_j^T$，方差为 $\sigma^2$

因此，$D_{11}$的概率密度函数为：

$p(D_{11} \mid U_1, V_1) = \frac{1}{\sqrt{2\pi \sigma^2}} \exp \left( -\frac{(D_{11} - U_1 \cdot V_1)^2}{2\sigma^2} \right)$

带入已知数据：

- $D_{11} = 5$（观测值），
- $V_1 = 0.8$（初始化值），
- $\sigma^2 = 1$（噪声方差）。

于是似然函数为：

$p(D_{11} \mid U_1, V_1 = 0.8) = \frac{1}{\sqrt{2\pi}} \exp \left( -\frac{(5 - U_1 \cdot 0.8)^2}{2} \right)$

这是一个关于 $U_1$的概率密度函数。

------

## 3. 先验分布的形式

根据假设，$U_1$U服从标准正态分布：

$p(U_1) = \frac{1}{\sqrt{2\pi}} \exp \left( -\frac{U_1^2}{2} \right)$

这是一个关于 $U_1$ 的正态分布，均值为 0，方差为 1。

------

## 4. 后验分布的推导

根据贝叶斯定理，$U_1$ 的后验分布是似然函数和先验分布的乘积：

$p(U_1 \mid D_{11}, V_1) \propto p(D_{11} \mid U_1, V_1) \cdot p(U_1)$

将似然函数和先验分布代入：

$p(U_1 \mid D_{11}, V_1) \propto \exp \left( -\frac{(5 - U_1 \cdot 0.8)^2}{2} \right) \cdot \exp \left( -\frac{U_1^2}{2} \right)$

由于指数函数相乘相当于指数中的项相加，简化为：

$p(U_1 \mid D_{11}, V_1) \propto \exp \left( -\frac{(5 - U_1 \cdot 0.8)^2 + U_1^2}{2} \right)$

这仍然是一个正态分布的形式。接下来，我们要通过化简确定其 **均值** 和 **方差**。

------

## 5. 化简与计算后验分布的均值和方差

我们需要将上式中的平方项展开，然后通过配方来确定后验分布的均值和方差。

### 5.1 展开平方项

首先，展开$(5 - U_1 \cdot 0.8)^2$：

$(5 - U_1 \cdot 0.8)^2 = 25 - 2 \cdot 5 \cdot 0.8 \cdot U_1 + (0.8^2 \cdot U_1^2)$

带入上面的后验分布表达式：

$p(U_1 \mid D_{11}, V_1) \propto \exp \left( -\frac{25 - 8U_1 + 0.64 U_1^2 + U_1^2}{2} \right)$

$p(U_1 \mid D_{11}, V_1) \propto \exp \left( -\frac{25 - 8U_1 + 1.64 U_1^2}{2} \right)$

### 5.2 配方求均值和方差

通过配方法，得到新的正态分布形式：

$p(U_1 \mid D_{11}, V_1) \sim N(\mu_{U_1}, \sigma_{U_1}^2)$

其中：

- **均值** $\mu_{U_1}$：

  $\mu_{U_1} = \frac{5 \cdot 0.8}{1.64} = \frac{4}{1.64} \approx 2.44$

- **方差** $\sigma_{U_1}^2$：

  $\sigma_{U_1}^2 = \frac{1}{1.64} \approx 0.61$

因此，$U_1$ 的后验分布是：

$p(U_1 \mid D_{11}, V_1) \sim N(2.44, 0.61)$

------

## 6. 从后验分布中采样

现在我们知道 $U_1$ 的后验分布是 $N(2.44, 0.61)$，可以从这个分布中采样得到一个新的 $U_1$值。假设我们采样的结果是 $U_1 = 2.0$。

这个 $U_1$ 就是更新后的值。

------

## 总结

通过结合 **似然函数** 和 **先验分布**，使用贝叶斯定理，我们得到了 $U_1$ 的后验分布。

具体步骤是：

1. 写出似然函数 $p(D_{11} \mid U_1, V_1)$，这是正态分布。
2. 写出先验分布 $p(U_1)$，假设是正态分布。
3. 将两者相乘，得到后验分布的形式，并通过配方计算得到后验分布的均值和方差。
4. 从后验分布中抽样，更新参数。