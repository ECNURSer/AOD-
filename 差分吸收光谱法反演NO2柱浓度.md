# 差分吸收光谱法反演NO2柱浓度

TROPOMI是安装在欧洲气象卫星Sentinel-5P上的成像光谱仪，能够提供高分辨率的光谱数据。首先需要从卫星数据中心下载TROPOMI的原始光谱数据。

### 2. 光谱预处理
对原始光谱数据进行预处理，包括：
- **辐射校正**：将原始光谱数据转换为物理辐射值。
- **光谱校正**：校正仪器的波长漂移和光谱响应不均匀性。
- **去除散射光**：去除可能影响测量结果的散射光成分。

### 3. DOAS分析
差分吸收光谱法的核心步骤包括：
- **参考光谱选择**：选择一个无污染区域的光谱作为参考光谱。
- **差分吸收计算**：将测量光谱与参考光谱进行比较，计算出差分吸收光谱。
- **拟合过程**：将差分吸收光谱与已知的NO2吸收截面进行拟合，得到NO2的柱浓度。

### 4. 大气校正
由于大气中存在气溶胶和其他气体的散射和吸收，需要进行大气校正：
- **气溶胶校正**：使用气溶胶模式或其他辅助数据，校正气溶胶的影响。
- **其他气体校正**：考虑其他气体（如臭氧、氧气等）对NO2测量的干扰，进行相应的校正。

### 5. 垂直柱浓度计算
从DOAS分析中得到的是NO2的斜柱浓度（沿光程的浓度积分）。需要将斜柱浓度转换为垂直柱浓度：
- **AMF（Air Mass Factor）计算**：计算空气质量因子（AMF），它描述了大气层中NO2的垂直分布特征。
- **斜柱浓度到垂直柱浓度的转换**：使用AMF将斜柱浓度转换为垂直柱浓度。

### 6. 数据校验与验证
反演得到的NO2柱浓度需要进行校验和验证：
- **地面观测数据对比**：与地面监测站的数据进行对比，验证结果的准确性。
- **模型模拟数据对比**：与大气化学传输模型的模拟结果进行比对，进一步验证反演结果。

### 7. 数据发布与应用
经过校验和验证的NO2柱浓度数据可以发布，并应用于大气环境监测、空气质量评估、污染源识别等方面。

### 总结
利用TROPOMI数据反演NO2柱浓度的过程涉及数据获取、光谱预处理、DOAS分析、大气校正、垂直柱浓度计算和数据校验等多个步骤。每一步都需要精确的计算和校正，以确保最终结果的准确性和可靠性。

## 
### DOAS分析过程

#### 1. 参考光谱选择
选择一个无污染区域的光谱作为参考光谱 $ I_0(\lambda) $。这个参考光谱通常是来自于同一条轨道上光学路径较短、污染较少的区域。

#### 2. 差分吸收计算
测量光谱 $ I(\lambda) $ 与参考光谱 $ I_0(\lambda) $ 的比值可以表示为：
$$
 \frac{I(\lambda)}{I_0(\lambda)} = e^{-\tau(\lambda)} 
$$
其中，$\tau(\lambda)$ 是总的光学厚度，包括吸收和散射成分。

#### 3. 拟合过程
差分吸收光谱 $\Delta\tau(\lambda)$ 可以表示为：
$$
 \Delta\tau(\lambda) = \tau(\lambda) - \tau_{\text{smooth}}(\lambda) 
$$
其中，$\tau_{\text{smooth}}(\lambda)$ 是平滑的光学厚度，用于去除宽带吸收和散射的影响。

对于NO2，差分吸收光谱可以进一步分解为：
$$
 \Delta\tau(\lambda) = \sum_i S_i \sigma_i(\lambda) + P(\lambda) 
$$
其中：
- $ S_i $ 是第 $i$ 种气体的柱浓度（斜柱浓度）。
- $ \sigma_i(\lambda) $ 是第 $i$ 种气体的吸收截面。
- $ P(\lambda) $ 是多项式，用于拟合光谱中的平滑成分。

通过线性最小二乘法拟合上述方程，可以得到NO2的斜柱浓度 $ S_{\text{NO2}} $。

### 垂直柱浓度计算过程

#### 1. 空气质量因子（AMF）计算
空气质量因子（AMF, Air Mass Factor）用于将斜柱浓度转换为垂直柱浓度。AMF定义为：
$$
 \text{AMF} = \frac{S_{\text{slant}}}{S_{\text{vertical}}} 
$$
其中，$ S_{\text{slant}} $ 是斜柱浓度，$ S_{\text{vertical}} $ 是垂直柱浓度。

AMF的计算通常依赖于辐射传输模型（如DISAMAR、SCIATRAN等），考虑了大气中NO2的垂直分布、太阳天顶角、观测天顶角、地表反射率和大气散射等因素。

#### 2. 斜柱浓度到垂直柱浓度的转换
利用计算得到的AMF，可以将斜柱浓度转换为垂直柱浓度：
$$
 S_{\text{vertical}} = \frac{S_{\text{slant}}}{\text{AMF}} 
$$








### 示例数据

假设我们有以下数据：
- 测量光谱 $ I(\lambda) $
- 参考光谱 $ I_0(\lambda) $
- NO2吸收截面 $ \sigma_{\text{NO2}}(\lambda) $
- 波长范围为 $ \lambda = 400 $ nm 到 $ \lambda = 450 $ nm

#### 1. 参考光谱选择
选择一个无污染区域的光谱作为参考光谱 $ I_0(\lambda) $。假设参考光谱 $ I_0(\lambda) $ 已经选定并预处理完毕。

#### 2. 差分吸收计算
首先，计算测量光谱和参考光谱的比值：
$$
 \frac{I(\lambda)}{I_0(\lambda)} = e^{-\tau(\lambda)}
$$
假设在波长范围 $ \lambda = 400 $ nm 到 $ \lambda = 450 $ nm 内，我们有以下测量光谱和参考光谱数据（取样点）：

| 波长 (nm) | 测量光谱 $ I(\lambda) $ | 参考光谱 $ I_0(\lambda) $ |
|-----------|----------------------------|------------------------------|
| 400       | 0.8                        | 1.0                          |
| 405       | 0.85                       | 1.0                          |
| 410       | 0.82                       | 1.0                          |
| 415       | 0.78                       | 1.0                          |
| 420       | 0.75                       | 1.0                          |
| 425       | 0.73                       | 1.0                          |
| 430       | 0.70                       | 1.0                          |
| 435       | 0.68                       | 1.0                          |
| 440       | 0.65                       | 1.0                          |
| 445       | 0.63                       | 1.0                          |
| 450       | 0.60                       | 1.0                          |

计算比值 $ \frac{I(\lambda)}{I_0(\lambda)} $：

| 波长 (nm) | 比值 $ \frac{I(\lambda)}{I_0(\lambda)} $ |
| --------- | ---------------------------------------- |
| 400       | 0.8                                      |
| 405       | 0.85                                     |
| 410       | 0.82                                     |
| 415       | 0.78                                     |
| 420       | 0.75                                     |
| 425       | 0.73                                     |
| 430       | 0.70                                     |
| 435       | 0.68                                     |
| 440       | 0.65                                     |
| 445       | 0.63                                     |
| 450       | 0.60                                     |

接着计算光学厚度 $\tau(\lambda)$：
\[ \tau(\lambda) = -\ln \left( \frac{I(\lambda)}{I_0(\lambda)} \right) \]

| 波长 (nm) | 比值 $ \frac{I(\lambda)}{I_0(\lambda)} $ | 光学厚度 $\tau(\lambda)$ |
| --------- | ---------------------------------------- | ------------------------ |
| 400       | 0.8                                      | 0.223                    |
| 405       | 0.85                                     | 0.162                    |
| 410       | 0.82                                     | 0.198                    |
| 415       | 0.78                                     | 0.248                    |
| 420       | 0.75                                     | 0.288                    |
| 425       | 0.73                                     | 0.314                    |
| 430       | 0.70                                     | 0.357                    |
| 435       | 0.68                                     | 0.385                    |
| 440       | 0.65                                     | 0.431                    |
| 445       | 0.63                                     | 0.462                    |
| 450       | 0.60                                     | 0.511                    |

#### 3. 拟合过程
将光学厚度 $\tau(\lambda)$ 分解为差分吸收光谱 $\Delta\tau(\lambda)$ 和光滑成分 $\tau_{\text{smooth}}(\lambda)$。

假设我们有NO2的吸收截面数据 $ \sigma_{\text{NO2}}(\lambda) $：

| 波长 (nm) | 吸收截面 $ \sigma_{\text{NO2}}(\lambda) $ (单位: $ \text{cm}^2/\text{molecule} $) |
| --------- | ------------------------------------------------------------ |
| 400       | 2.0 \times 10^{-19}                                          |
| 405       | 1.9 \times 10^{-19}                                          |
| 410       | 1.8 \times 10^{-19}                                          |
| 415       | 2.1 \times 10^{-19}                                          |
| 420       | 2.2 \times 10^{-19}                                          |
| 425       | 2.3 \times 10^{-19}                                          |
| 430       | 2.4 \times 10^{-19}                                          |
| 435       | 2.5 \times 10^{-19}                                          |
| 440       | 2.6 \times 10^{-19}                                          |
| 445       | 2.7 \times 10^{-19}                                          |
| 450       | 2.8 \times 10^{-19}                                          |

拟合过程：将差分吸收光谱 $\Delta\tau(\lambda)$ 拟合为NO2吸收截面和多项式的线性组合：
$$
 \Delta\tau(\lambda) = S_{\text{NO2}} \sigma_{\text{NO2}}(\lambda) + P(\lambda) 
$$
通过线性最小二乘法拟合，可以得到NO2的斜柱浓度 $ S_{\text{NO2}} $。

假设拟合结果为：
$$
 S_{\text{NO2}} = 1.5 \times 10^{16} \, \text{molecules/cm}^2 
$$




## $\tau_{\text{smooth}}(\lambda)$ 和 $P(\lambda)$ 怎么得到呢



### $\tau_{\text{smooth}}(\lambda)$ 的计算

$\tau_{\text{smooth}}(\lambda)$ 是光学厚度中的平滑成分，通常表示为一个低阶多项式。它用于去除宽带吸收和散射的影响。具体步骤如下：

1. **选择波长范围**：选择一个合适的波长范围（例如400 nm到450 nm），确保包含了目标气体的吸收特征。

2. **拟合光学厚度**：使用低阶多项式（如一阶或二阶多项式）拟合测量的光学厚度 $\tau(\lambda)$。拟合多项式可以表示为：
   $$
   \tau_{\text{smooth}}(\lambda) = a_0 + a_1 \lambda + a_2 \lambda^2 + \cdots
   $$
   其中，$a_0, a_1, a_2, \ldots$ 是拟合参数。

3. **去除平滑成分**：从总的光学厚度 $\tau(\lambda)$ 中减去拟合得到的平滑成分 $\tau_{\text{smooth}}(\lambda)$，得到差分光学厚度 $\Delta\tau(\lambda)$：
   $$
   \Delta\tau(\lambda) = \tau(\lambda) - \tau_{\text{smooth}}(\lambda)
   $$
   

### $P(\lambda)$ 的计算

在DOAS分析中，$P(\lambda)$ 是用于拟合光谱中的平滑成分的多项式。它通常表示为一个低阶多项式，类似于$\tau_{\text{smooth}}(\lambda)$。具体步骤如下：

1. **选择波长范围**：选择一个合适的波长范围（例如400 nm到450 nm），确保包含了目标气体的吸收特征。

2. **构建多项式**：构建一个低阶多项式（如一阶或二阶多项式），表示为：
   $$
   P(\lambda) = b_0 + b_1 \lambda + b_2 \lambda^2 + \cdots
   $$
   其中，$b_0, b_1, b_2, \ldots$ 是拟合参数。

3. **拟合光谱数据**：在拟合过程中，将差分光学厚度 $\Delta\tau(\lambda)$ 拟合为目标气体的吸收截面 $\sigma_{\text{NO2}}(\lambda)$ 和多项式 $P(\lambda)$ 的线性组合：
   $$
   \Delta\tau(\lambda) = S_{\text{NO2}} \sigma_{\text{NO2}}(\lambda) + P(\lambda)
   $$
   

### 示例数据说明

假设我们有以下光学厚度数据：
| 波长 (nm) | 光学厚度 $\tau(\lambda)$ |
| --------- | ------------------------ |
| 400       | 0.223                    |
| 405       | 0.162                    |
| 410       | 0.198                    |
| 415       | 0.248                    |
| 420       | 0.288                    |
| 425       | 0.314                    |
| 430       | 0.357                    |
| 435       | 0.385                    |
| 440       | 0.431                    |
| 445       | 0.462                    |
| 450       | 0.511                    |

1. **拟合平滑成分**：使用二阶多项式拟合光学厚度 $\tau(\lambda)$：
   $$
   \tau_{\text{smooth}}(\lambda) = a_0 + a_1 \lambda + a_2 \lambda^2
   $$
   假设拟合得到的参数为：
   $$
   a_0 = 0.1, \quad a_1 = 2 \times 10^{-4}, \quad a_2 = 1 \times 10^{-6}
   $$
   则平滑成分为：
   $$
   \tau_{\text{smooth}}(\lambda) = 0.1 + 2 \times 10^{-4} \lambda + 1 \times 10^{-6} \lambda^2
   $$
   
   
2. **计算差分光学厚度**：从总的光学厚度中减去平滑成分：
   $$
   \Delta\tau(\lambda) = \tau(\lambda) - \tau_{\text{smooth}}(\lambda)
   $$
   例如，对于波长400 nm：
   $$
   \tau_{\text{smooth}}(400) = 0.1 + 2 \times 10^{-4} \times 400 + 1 \times 10^{-6} \times 400^2 = 0.184
   $$
   
   $$
   \Delta\tau(400) = 0.223 - 0.184 = 0.039
   $$

   对所有波长计算差分光学厚度。

3. **拟合差分光学厚度**：将差分光学厚度 $\Delta\tau(\lambda)$ 拟合为NO2吸收截面和多项式的线性组合：
   $$
   \Delta\tau(\lambda) = S_{\text{NO2}} \sigma_{\text{NO2}}(\lambda) + P(\lambda)
   $$
   通过线性最小二乘法拟合，得到NO2的斜柱浓度 $S_{\text{NO2}}$ 和多项式 $P(\lambda)$ 的参数。

### 总结

通过拟合低阶多项式 $\tau_{\text{smooth}}(\lambda)$ 和 $P(\lambda)$，可以去除光学厚度中的宽带吸收和散射影响，从而得到差分光学厚度 $\Delta\tau(\lambda)$。然后，通过线性最小二乘法拟合差分光学厚度，可以得到目标气体的斜柱浓度。